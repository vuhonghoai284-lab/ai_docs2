# API 测试用例清单

## 测试范围概述

### 重构后API架构测试覆盖
- **系统API** (`SystemView`): 系统配置和基础功能
- **认证API** (`AuthView`): 用户认证和权限管理
- **任务API** (`TaskView`): 文档测试任务CRUD操作
- **用户API** (`UserView`): 用户信息管理
- **AI输出API** (`AIOutputView`): AI分析结果查询
- **问题API** (`IssueView`): 问题反馈处理
- **日志API** (`TaskLogView`): 任务日志查询

## 1. 系统API测试用例

### 1.1 基础系统API
| 测试用例ID | API端点 | HTTP方法 | 测试目标 | 优先级 |
|-----------|---------|----------|----------|--------|
| SYS-001 | `/` | GET | 根路径系统信息 | P0 |
| SYS-002 | `/api/config` | GET | 客户端配置获取 | P0 |
| SYS-003 | `/api/models` | GET | AI模型列表获取 | P0 |

### 1.2 WebSocket API
| 测试用例ID | API端点 | 协议 | 测试目标 | 优先级 |
|-----------|---------|------|----------|--------|
| WS-001 | `/ws/task/{task_id}/logs` | WebSocket | 实时日志推送 | P1 |

## 2. 认证API测试用例

### 2.1 第三方认证
| 测试用例ID | API端点 | HTTP方法 | 测试目标 | 优先级 |
|-----------|---------|----------|----------|--------|
| AUTH-001 | `/api/auth/thirdparty/url` | GET | 获取第三方认证URL | P0 |
| AUTH-002 | `/api/auth/thirdparty/login` | POST | 第三方登录 | P0 |
| AUTH-003 | `/api/auth/system/login` | POST | 系统管理员登录 | P0 |

### 2.2 权限验证
| 测试用例ID | 测试场景 | 测试目标 | 优先级 |
|-----------|----------|----------|--------|
| AUTH-004 | 无token访问受保护资源 | 401未授权 | P0 |
| AUTH-005 | 无效token访问受保护资源 | 401未授权 | P0 |
| AUTH-006 | 过期token访问受保护资源 | 401未授权 | P1 |
| AUTH-007 | 普通用户访问管理员资源 | 403权限不足 | P0 |

## 3. 任务API测试用例

### 3.1 任务CRUD操作
| 测试用例ID | API端点 | HTTP方法 | 测试目标 | 优先级 |
|-----------|---------|----------|----------|--------|
| TASK-001 | `/api/tasks` | POST | 创建任务（需认证） | P0 |
| TASK-002 | `/api/tasks` | GET | 获取任务列表（需认证） | P0 |
| TASK-003 | `/api/tasks/{task_id}` | GET | 获取任务详情（需认证+权限） | P0 |
| TASK-004 | `/api/tasks/{task_id}` | DELETE | 删除任务（需认证+权限） | P0 |

### 3.2 任务业务操作
| 测试用例ID | API端点 | HTTP方法 | 测试目标 | 优先级 |
|-----------|---------|----------|----------|--------|
| TASK-005 | `/api/tasks/{task_id}/retry` | POST | 重试任务（需认证+权限） | P1 |
| TASK-006 | `/api/tasks/{task_id}/report` | GET | 下载报告（需认证+权限） | P1 |

### 3.3 文件上传测试
| 测试用例ID | 测试场景 | 测试目标 | 优先级 |
|-----------|----------|----------|--------|
| TASK-007 | 支持的文件类型上传 | 成功创建任务 | P0 |
| TASK-008 | 不支持的文件类型上传 | 400错误 | P0 |
| TASK-009 | 超大文件上传 | 400错误 | P0 |
| TASK-010 | 空文件上传 | 400错误 | P1 |

## 4. 用户API测试用例

### 4.1 用户信息管理
| 测试用例ID | API端点 | HTTP方法 | 测试目标 | 优先级 |
|-----------|---------|----------|----------|--------|
| USER-001 | `/api/users/me` | GET | 获取当前用户信息（需认证） | P0 |
| USER-002 | `/api/users` | GET | 获取所有用户（需管理员权限） | P0 |

## 5. AI输出API测试用例

### 5.1 AI输出查询
| 测试用例ID | API端点 | HTTP方法 | 测试目标 | 优先级 |
|-----------|---------|----------|----------|--------|
| AI-001 | `/api/tasks/{task_id}/ai-outputs` | GET | 获取任务AI输出（需认证+权限） | P0 |
| AI-002 | `/api/ai-outputs/{output_id}` | GET | 获取AI输出详情（需认证+权限） | P0 |

### 5.2 过滤和查询
| 测试用例ID | 测试场景 | 测试目标 | 优先级 |
|-----------|----------|----------|--------|
| AI-003 | 按操作类型过滤AI输出 | 正确过滤结果 | P1 |

## 6. 问题API测试用例

### 6.1 问题反馈
| 测试用例ID | API端点 | HTTP方法 | 测试目标 | 优先级 |
|-----------|---------|----------|----------|--------|
| ISSUE-001 | `/api/issues/{issue_id}/feedback` | PUT | 提交问题反馈（需认证+权限） | P0 |

## 7. 日志API测试用例

### 7.1 日志查询
| 测试用例ID | API端点 | HTTP方法 | 测试目标 | 优先级 |
|-----------|---------|----------|----------|--------|
| LOG-001 | `/api/tasks/{task_id}/logs/history` | GET | 获取任务历史日志（需认证+权限） | P0 |

## E2E端到端测试用例

### E2E-001: 完整文档测试流程
1. 系统管理员登录
2. 获取AI模型列表
3. 创建文档测试任务
4. 监控任务执行状态
5. 查看AI分析输出
6. 处理检测到的问题
7. 提交问题反馈
8. 下载测试报告

### E2E-002: 第三方用户完整流程
1. 获取第三方认证URL
2. 模拟第三方认证回调
3. 第三方用户登录
4. 创建个人任务
5. 查看个人任务列表
6. 查看任务详情和结果

### E2E-003: 权限隔离验证
1. 创建两个不同用户
2. 用户A创建任务
3. 用户B尝试访问用户A的任务
4. 验证权限隔离有效

### E2E-004: 并发任务处理
1. 同时创建多个任务
2. 验证任务队列处理
3. 检查资源竞争问题
4. 确认任务结果正确性

## 性能测试用例

### PERF-001: API响应性能
- 所有GET API响应时间 < 500ms
- 文件上传API响应时间 < 2000ms
- 并发10个用户正常响应

### PERF-002: 数据库性能
- 任务列表查询性能（1000+任务）
- AI输出查询性能（大量输出数据）

## 安全测试用例

### SEC-001: SQL注入防护
- 所有输入参数SQL注入测试
- 文件名注入测试

### SEC-002: XSS防护
- 输入数据XSS攻击测试
- 文件内容XSS测试

### SEC-003: 文件上传安全
- 恶意文件上传防护
- 文件路径遍历攻击防护

## 测试数据准备

### 测试用户数据
```json
{
  "admin_user": {
    "uid": "sys_admin",
    "display_name": "系统管理员",
    "email": "admin@example.com",
    "is_admin": true,
    "is_system_admin": true
  },
  "normal_user": {
    "uid": "test_user_001",
    "display_name": "测试用户001", 
    "email": "user001@example.com",
    "is_admin": false,
    "is_system_admin": false
  }
}
```

### 测试文件数据
- 有效的Markdown文件（小于10MB）
- 有效的PDF文件（小于10MB）
- 有效的Word文档（小于10MB）
- 无效的文件类型（.exe, .zip等）
- 超大文件（>10MB）
- 空文件

## 测试报告要求

### 基本报告内容
1. **测试执行概况**
   - 测试用例总数
   - 通过/失败/跳过数量
   - 测试覆盖率

2. **API响应性能统计**
   - 平均响应时间
   - 95%响应时间
   - 最慢响应时间

3. **失败用例详情**
   - 失败原因分析
   - 错误堆栈信息
   - 重现步骤

4. **覆盖率报告**
   - 代码行覆盖率
   - 分支覆盖率
   - 文件覆盖率

### 报告输出格式
- HTML可视化报告
- JSON结构化数据
- JUnit XML格式（CI/CD集成）
- PDF汇总报告