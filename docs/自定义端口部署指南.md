# 自定义端口部署指南

当你需要修改后端端口或使用IP地址访问时，请按照以下步骤操作，避免出现"Invalid HTTP request received"错误。

## 🔍 问题原因

当修改后端端口时，常见的问题包括：
1. **CORS配置不匹配**：前端地址不在CORS允许列表中
2. **前端API地址错误**：前端仍然指向原端口
3. **第三方登录回调URL不匹配**：回调地址与新端口不符

## 🛠️ 解决方案

### 1. 后端配置修改

#### 方法1：使用自定义配置文件
```bash
# 复制示例配置
cp config.port-deploy.yaml config.custom.yaml

# 编辑配置文件
nano config.custom.yaml
```

修改端口配置：
```yaml
server:
  host: "0.0.0.0"
  port: 8081  # 你的自定义端口
  debug: true  # 开发模式，启用宽松CORS
```

#### 方法2：使用环境变量
```bash
# 设置环境变量
export SERVER_PORT=8081
export CORS_DEVELOPMENT_MODE=true
export FRONTEND_URL=http://192.168.1.100:3000  # 你的前端地址
```

### 2. 前端配置修改

#### 修改前端环境变量
编辑 `frontend/.env`：
```env
# API配置 - 指向新的后端地址
VITE_API_BASE_URL=http://192.168.1.100:8081/api
VITE_WS_BASE_URL=ws://192.168.1.100:8081

# 前端服务器配置
VITE_HOST=0.0.0.0
VITE_PORT=3000
```

#### 或使用IP地址访问时的动态配置
前端会自动检测当前访问地址，但你也可以明确指定：
```env
# 明确指定后端地址（推荐用于生产环境）
VITE_API_BASE_URL=http://your-server-ip:8081/api
```

### 3. 启动方式

#### 后端启动
```bash
# 使用自定义配置文件
CONFIG_FILE=config.custom.yaml python app/main.py

# 或使用环境变量
SERVER_PORT=8081 CORS_DEVELOPMENT_MODE=true python app/main.py
```

#### 前端启动
```bash
cd frontend
npm run dev
```

## 🔧 高级配置

### CORS开发模式
系统会自动检测以下情况并启用宽松的CORS策略：
- 端口不是默认8080
- 启用了调试模式
- 设置了`CORS_DEVELOPMENT_MODE=true`

### 支持的CORS地址模式
开发模式下自动支持：
- `http://localhost:3000`
- `http://localhost:5173`
- `http://127.0.0.1:3000`
- `http://127.0.0.1:5173`
- 环境变量`FRONTEND_URL`指定的地址

### 第三方登录配置
如果使用第三方登录，需要更新回调URL：
```bash
# 设置第三方登录回调地址
export THIRD_PARTY_REDIRECT_URL=http://your-server-ip:3000/callback
```

## 🐛 故障排除

### 1. "Invalid HTTP request received"
**原因**：CORS配置不匹配
**解决**：
```bash
# 启用开发模式CORS
export CORS_DEVELOPMENT_MODE=true

# 或明确指定前端地址
export FRONTEND_URL=http://your-frontend-ip:3000
```

### 2. 系统管理员登录失败
**原因**：前端API地址配置错误
**解决**：
1. 检查前端`.env`文件中的`VITE_API_BASE_URL`
2. 确认后端端口正确启动
3. 检查网络连接

### 3. 第三方登录失败
**原因**：回调URL不匹配
**解决**：
1. 更新`THIRD_PARTY_REDIRECT_URL`环境变量
2. 确认第三方应用配置中的回调URL
3. 检查CORS配置

## 📝 快速测试

### 测试CORS配置
```bash
# 检查CORS配置是否生效
curl -H "Origin: http://localhost:3000" \
     -H "Access-Control-Request-Method: POST" \
     -H "Access-Control-Request-Headers: X-Requested-With" \
     -X OPTIONS \
     http://your-server-ip:8081/api/system/health
```

### 测试系统管理员登录
```bash
# 测试登录API
curl -X POST http://your-server-ip:8081/api/auth/system/login \
     -H "Content-Type: application/x-www-form-urlencoded" \
     -d "username=admin&password=admin123"
```

## 💡 最佳实践

1. **开发环境**：启用`debug: true`和`development_mode: true`
2. **生产环境**：明确配置所有地址，关闭调试模式
3. **安全考虑**：生产环境中限制CORS来源，避免使用通配符
4. **文档记录**：记录你的自定义配置，便于团队协作

## 🔗 相关文件

- `backend/config.yaml` - 默认配置
- `backend/config.port-deploy.yaml` - 自定义端口部署示例
- `frontend/.env` - 前端环境变量
- `backend/app/core/config.py` - 配置处理逻辑
- `backend/app/main.py` - CORS中间件配置

按照以上配置，你就能成功在自定义端口上部署并避免CORS相关的错误。