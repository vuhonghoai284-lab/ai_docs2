# AI资料自主测试系统 - 任务清单（精简版）

## 一、数据模型设计

### 1. 任务表 (Tasks)

- id: 主键，自增ID  
- title: 任务标题
- status: 任务状态（pending/processing/completed/failed）
- progress: 执行进度（0-100）
- total_files: 总文件数
- created_at: 创建时间
- completed_at: 完成时间
- error_message: 错误信息

### 2. 文件表 (Files)

- id: 主键，自增ID
- task_id: 关联任务ID
- file_name: 原始文件名
- file_path: 存储路径
- file_size: 文件大小（字节）
- file_type: 文件类型（pdf/docx/md）
- created_at: 创建时间

### 3. 检测问题表 (Issues)

- id: 主键，自增ID
- task_id: 关联任务ID
- file_id: 关联文件ID
- issue_type: 问题类型（语法/逻辑/完整性）
- description: 问题描述
- location: 所在位置
- severity: 严重程度（高/中/低）
- suggestion: 改进建议
- created_at: 创建时间

### 4. 用户反馈表 (Feedback)

- id: 主键，自增ID
- issue_id: 关联问题ID
- feedback_type: 反馈类型（accept/reject）
- comment: 用户评价（可选）
- created_at: 创建时间

## 二、核心页面开发

### 1. 任务创建页面

**功能：**
- 文件上传（拖拽/点击，多文件）
- 任务标题输入
- 一键提交创建任务

**开发任务：**
- [ ] 实现文件上传组件
- [ ] 文件验证（类型、大小）
- [ ] 任务创建API调用

### 2. 任务列表页面

**功能：**
- 显示所有任务
- 任务状态和进度显示
- 基本操作（查看详情、删除）

**开发任务：**
- [ ] 任务列表展示
- [ ] 任务卡片组件
- [ ] 基本操作按钮

### 3. 任务详情页面

**功能：**
- 任务基本信息
- 文件列表
- 问题审核界面
- 报告下载

**开发任务：**
- [ ] 任务信息展示
- [ ] 问题列表组件
- [ ] 反馈操作组件
- [ ] 报告下载按钮

## 三、核心API接口

### 1. 任务管理

```
POST   /api/tasks              # 创建任务
GET    /api/tasks              # 获取任务列表
GET    /api/tasks/{id}         # 获取任务详情
DELETE /api/tasks/{id}         # 删除任务
GET    /api/tasks/{id}/progress # 获取进度
```

### 2. 问题和反馈

```
GET    /api/tasks/{id}/issues           # 获取问题列表
POST   /api/issues/{id}/feedback        # 提交反馈
```

### 3. 报告

```
GET    /api/tasks/{id}/report           # 下载报告
```

## 四、后端核心模块

### 1. 文件处理

```python
class FileProcessor:
    def parse_file(self, file_path: str) -> str:
        """解析文件，返回文本内容"""
        if file_path.endswith('.pdf'):
            return self.parse_pdf(file_path)
        elif file_path.endswith('.docx'):
            return self.parse_word(file_path)
        elif file_path.endswith('.md'):
            return self.parse_markdown(file_path)
    
    def chunk_text(self, text: str, chunk_size: int = 8000) -> List[str]:
        """文本分块"""
        return [text[i:i+chunk_size] for i in range(0, len(text), chunk_size)]
```

### 2. AI调用

```python
class AIService:
    def __init__(self, api_host: str):
        self.api_host = api_host
    
    async def detect_issues(self, text: str) -> List[Dict]:
        """调用AI检测问题"""
        prompt = f"""
        请分析以下文档内容的质量问题，从语法、逻辑、完整性三个维度评估：
        
        输出JSON格式：
        {{
          "issues": [
            {{
              "type": "语法/逻辑/完整性",
              "description": "问题描述",
              "location": "所在位置",
              "severity": "高/中/低",
              "suggestion": "改进建议"
            }}
          ]
        }}
        
        文档内容：{text}
        """
        return await self.call_api(prompt)
```

### 3. 任务处理器

```python
class TaskProcessor:
    async def process_task(self, task_id: int):
        """处理任务"""
        task = get_task(task_id)
        task.status = 'processing'
        
        try:
            # 1. 解析文件
            for file in task.files:
                content = self.file_processor.parse_file(file.file_path)
                chunks = self.file_processor.chunk_text(content)
                
                # 2. AI检测
                for chunk in chunks:
                    issues = await self.ai_service.detect_issues(chunk)
                    self.save_issues(task_id, file.id, issues)
                
                task.progress += 100 / len(task.files)
                task.save()
            
            # 3. 完成任务
            task.status = 'completed'
            task.completed_at = datetime.now()
            task.save()
            
        except Exception as e:
            task.status = 'failed'
            task.error_message = str(e)
            task.save()
```

### 4. 报告生成

```python
class ReportGenerator:
    def generate_excel_report(self, task_id: int) -> str:
        """生成Excel报告"""
        task = get_task(task_id)
        issues = get_issues(task_id)
        feedbacks = get_feedbacks(task_id)
        
        wb = Workbook()
        ws = wb.active
        ws.title = "问题汇总"
        
        # 写入表头
        headers = ['序号', '问题类型', '问题描述', '位置', '严重程度', '建议', '用户反馈', '用户评价']
        ws.append(headers)
        
        # 写入数据
        for i, issue in enumerate(issues, 1):
            feedback = next((f for f in feedbacks if f.issue_id == issue.id), None)
            row = [
                i,
                issue.issue_type,
                issue.description,
                issue.location,
                issue.severity,
                issue.suggestion,
                feedback.feedback_type if feedback else '未反馈',
                feedback.comment if feedback else ''
            ]
            ws.append(row)
        
        # 保存文件
        file_path = f"reports/task_{task_id}_report.xlsx"
        wb.save(file_path)
        return file_path
```

## 五、配置和部署

### 1. 配置文件 (config.yaml)

```yaml
# 数据库配置
database:
  type: sqlite
  path: ./data/app.db

# AI模型配置  
ai_model:
  api_host: "http://localhost:8000"
  timeout: 30

# 文件配置
files:
  upload_dir: ./data/uploads
  report_dir: ./data/reports
  max_size: 10485760  # 10MB
  allowed_types: [pdf, docx, md]

# 服务配置
server:
  host: 0.0.0.0
  port: 8080
```

### 2. 启动脚本

```bash
#!/bin/bash
# 启动脚本

# 创建必要目录
mkdir -p data/uploads data/reports

# 启动后端
python app.py &

# 启动前端
cd frontend && npm start
```

## 六、开发计划

### 第一阶段：基础功能（1-2周）

1. **数据库和模型**
   - [ ] 创建SQLite数据库
   - [ ] 定义数据模型

2. **文件上传**
   - [ ] 实现文件上传接口
   - [ ] 文件验证逻辑
   - [ ] 前端上传组件

3. **任务创建**
   - [ ] 任务创建API
   - [ ] 任务列表API
   - [ ] 前端任务创建页面

### 第二阶段：核心处理（2-3周）

1. **文件解析**
   - [ ] PDF解析器
   - [ ] Word解析器
   - [ ] Markdown解析器

2. **AI集成**
   - [ ] AI调用封装
   - [ ] 问题检测逻辑
   - [ ] 结果存储

3. **任务处理**
   - [ ] 异步任务处理器
   - [ ] 进度更新机制
   - [ ] 错误处理

### 第三阶段：用户交互（1-2周）

1. **问题展示**
   - [ ] 问题列表页面
   - [ ] 问题详情组件

2. **用户反馈**
   - [ ] 反馈提交接口
   - [ ] 反馈操作组件

3. **报告生成**
   - [ ] Excel报告生成
   - [ ] 报告下载功能

### 第四阶段：测试和优化（1周）

1. **测试**
   - [ ] 功能测试
   - [ ] 错误场景测试

2. **优化**
   - [ ] 性能优化
   - [ ] 用户体验优化

## 七、技术栈

### 后端
- **框架**: FastAPI
- **数据库**: SQLite
- **文件解析**: PyPDF2, python-docx
- **Excel生成**: openpyxl

### 前端  
- **框架**: React + TypeScript
- **UI库**: Ant Design
- **状态管理**: React Context

### 部署
- **容器**: Docker（可选）
- **进程管理**: systemd/pm2