# 第三方登录配置指南

## 概述

本系统支持华为第三方OAuth2登录，本文档提供完整的配置和部署指南。

## 1. 系统架构

```
用户浏览器 → 第三方认证服务 → 回调到前端 → 后端API验证 → 完成登录
```

### 关键流程
1. 用户点击第三方登录按钮
2. 系统重定向到第三方认证页面
3. 用户在第三方系统完成认证
4. 第三方服务重定向回 `{FRONTEND_DOMAIN}/callback?code=xxx`
5. 前端CallbackHandler处理回调，调用后端API
6. 后端使用code换取token并获取用户信息
7. 完成登录流程

## 2. 配置要求

### 2.1 环境变量配置

创建 `.env` 文件（参考 `.env.example`）：

```bash
# 前端域名配置 - 关键配置！
FRONTEND_DOMAIN=http://localhost:5173  # 开发环境
# FRONTEND_DOMAIN=https://your-domain.com  # 生产环境

# 第三方OAuth2配置
THIRD_PARTY_CLIENT_ID=xyl
THIRD_PARTY_CLIENT_SECRET=your_actual_secret
THIRD_PARTY_AUTH_URL=https://uniportal.huawei.com/sasslogin1/oauth2/authorize
THIRD_PARTY_TOKEN_URL=https://uniportal.huawei.com/sasslogin1/oauth2/accesstoken
THIRD_PARTY_USERINFO_URL=https://uniportal.huawei.com/sasslogin1/oauth2/userinfo

# JWT配置
JWT_SECRET_KEY=your_super_secret_jwt_key

# CORS配置
FRONTEND_URL=http://localhost:5173
CORS_DEVELOPMENT_MODE=true
```

### 2.2 第三方平台配置

在华为第三方认证平台中注册应用时，需要配置：

**重定向URI:** `{您的前端域名}/callback`

示例：
- 开发环境：`http://localhost:5173/callback`
- 生产环境：`https://your-domain.com/callback`

## 3. 代码实现

### 3.1 前端实现

#### CallbackHandler组件
```tsx
// src/pages/CallbackHandler.tsx
// 处理第三方认证回调，解析code参数并完成登录
```

#### 路由配置
```tsx
// App.tsx 中添加
<Route path="/callback" element={<CallbackHandler />} />
```

#### 登录按钮
```tsx
// LoginPage.tsx 中的第三方登录逻辑
// 开发环境：模拟认证流程
// 生产环境：跳转到真实第三方认证页面
```

### 3.2 后端实现

#### 动态重定向URL配置
```python
# app/services/auth.py
def _get_redirect_url(self) -> str:
    frontend_domain = self.third_party_config.get("frontend_domain") 
    redirect_path = "/callback"
    return f"{frontend_domain}{redirect_path}"
```

#### API端点
- `GET /auth/thirdparty/url` - 获取第三方认证URL
- `POST /auth/thirdparty/login` - 使用code完成登录

## 4. 部署配置

### 4.1 开发环境

```bash
# .env 配置
FRONTEND_DOMAIN=http://localhost:5173
APP_MODE=development
CORS_DEVELOPMENT_MODE=true

# 启动命令
cd backend && python main.py &
cd frontend && npm run dev
```

### 4.2 测试环境

```bash
# .env 配置  
FRONTEND_DOMAIN=http://test-server.internal:3000
APP_MODE=test
CONFIG_FILE=config.test.yaml
```

### 4.3 生产环境

```bash
# .env 配置
FRONTEND_DOMAIN=https://ai-docs.your-company.com
APP_MODE=production
CORS_DEVELOPMENT_MODE=false

# 确保HTTPS配置
# 配置反向代理（Nginx/Apache）
# 申请SSL证书
```

## 5. 常见配置问题

### 5.1 重定向URL不匹配

**问题:** `redirect_url mismatch` 错误

**解决方案:**
1. 检查 `FRONTEND_DOMAIN` 环境变量是否正确
2. 确认第三方平台注册的重定向URI与实际配置一致
3. 注意HTTP vs HTTPS的区别

### 5.2 CORS错误

**问题:** 前端无法调用后端API

**解决方案:**
1. 确认 `FRONTEND_URL` 在CORS配置中
2. 开发环境设置 `CORS_DEVELOPMENT_MODE=true`
3. 检查前后端端口是否正确

### 5.3 Token交换失败

**问题:** 使用code换取token失败

**解决方案:**
1. 检查 `client_secret` 是否正确
2. 确认API端点URL是否正确
3. 检查网络连接和防火墙设置

## 6. 测试流程

### 6.1 开发环境测试

```bash
# 1. 配置环境变量
cp .env.example .env
# 编辑.env文件

# 2. 启动服务  
cd backend && python main.py &
cd frontend && npm run dev

# 3. 访问 http://localhost:5173
# 4. 点击"第三方登录"（开发模式自动模拟）
# 5. 验证登录成功
```

### 6.2 生产环境测试

```bash
# 1. 确认第三方平台配置
# 2. 部署到生产环境
# 3. 访问实际域名
# 4. 测试完整第三方认证流程
```

## 7. 安全注意事项

1. **HTTPS要求:** 生产环境必须使用HTTPS
2. **密钥安全:** 不要在代码中硬编码client_secret
3. **域名验证:** 确保重定向URL域名在允许列表中
4. **Token安全:** JWT密钥使用强随机字符串
5. **网络安全:** 配置适当的防火墙和安全组规则

## 8. 监控和日志

### 8.1 关键日志位置
- 后端认证日志：`./data/logs/app.log`  
- 第三方API调用日志：检查HTTP请求响应
- 前端浏览器控制台：检查JavaScript错误

### 8.2 监控指标
- 第三方登录成功率
- API响应时间
- 错误频率和类型
- 用户活跃度

## 9. 故障排查

### 9.1 常见错误码
- `400 Bad Request`: 参数错误，检查client_id、code等
- `401 Unauthorized`: 认证失败，检查client_secret
- `403 Forbidden`: 权限不足，检查应用配置
- `404 Not Found`: API端点错误，检查URL配置

### 9.2 调试步骤
1. 检查环境变量配置
2. 验证第三方平台设置
3. 查看后端日志
4. 检查网络连通性
5. 验证HTTPS证书（生产环境）

## 10. 联系支持

如果遇到配置问题，请提供以下信息：
- 环境配置（脱敏处理）
- 错误日志
- 部署环境描述
- 已尝试的解决方案