# AI资料自主测试系统 - 任务清单（最简版）

## 一、数据模型设计

### 1. 任务表 (Tasks)

- id: 主键，自增ID  
- title: 任务标题
- file_name: 文件名
- file_path: 文件存储路径
- file_size: 文件大小（字节）
- file_type: 文件类型（pdf/docx/md）
- status: 任务状态（pending/processing/completed/failed）
- progress: 执行进度（0-100）
- created_at: 创建时间
- completed_at: 完成时间
- error_message: 错误信息

### 2. 检测问题表 (Issues)

- id: 主键，自增ID
- task_id: 关联任务ID
- issue_type: 问题类型（语法/逻辑/完整性）
- description: 问题描述
- location: 所在位置
- severity: 严重程度（高/中/低）
- suggestion: 改进建议
- feedback_type: 用户反馈（accept/reject/null）
- feedback_comment: 用户评价
- created_at: 创建时间
- updated_at: 更新时间

## 二、核心页面开发

### 1. 任务创建页面

**功能：**
- 批量文件上传（支持多选）
- 自动为每个文件创建独立任务
- 显示上传进度和结果

**实现逻辑：**
```javascript
// 批量上传文件，创建多个任务
const handleFilesUpload = async (files: File[]) => {
  const tasks = [];
  for (const file of files) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('title', file.name.split('.')[0]);
    
    const response = await createTask(formData);
    tasks.push(response.data);
  }
  return tasks;
};
```

### 2. 任务列表页面

**功能：**
- 显示所有任务列表
- 任务状态和进度显示
- 操作按钮（查看/删除）

**界面示例：**
```
┌─────────────────────────────────────────────┐
│ 任务列表                          [新建任务] │
├─────────────────────────────────────────────┤
│ □ 文档1.pdf    ■■■■■■■■□□ 80%  处理中  [查看]│
│ □ 文档2.docx   ■■■■■■■■■■ 100% 已完成  [查看]│
│ □ 文档3.md     □□□□□□□□□□ 0%   等待中  [删除]│
└─────────────────────────────────────────────┘
```

### 3. 任务详情页面

**功能：**
- 任务基本信息
- 问题列表和反馈
- 报告下载

**界面示例：**
```
┌─────────────────────────────────────────────┐
│ 任务详情：文档1.pdf                         │
├─────────────────────────────────────────────┤
│ 状态：已完成  进度：100%  问题数：15        │
├─────────────────────────────────────────────┤
│ 问题列表：                                   │
│                                              │
│ 1. [语法] 第2页存在错别字                   │
│    位置：第2章第3段                         │
│    严重程度：中                              │
│    [✓接受] [✗拒绝] [评价___________]       │
│                                              │
│ 2. [逻辑] 章节结构不完整                    │
│    位置：第3章                              │
│    严重程度：高                              │
│    [✓接受] [✗拒绝] [评价___________]       │
├─────────────────────────────────────────────┤
│                              [下载报告]      │
└─────────────────────────────────────────────┘
```

## 三、核心API接口

### 1. 任务管理

```python
# 创建单个任务（一个文件）
POST /api/tasks
Content-Type: multipart/form-data
Body: 
  - file: 文件对象
  - title: 任务标题（可选）

Response:
{
  "id": 1,
  "title": "文档1",
  "file_name": "文档1.pdf",
  "status": "pending"
}

# 获取任务列表
GET /api/tasks

Response:
{
  "tasks": [
    {
      "id": 1,
      "title": "文档1",
      "file_name": "文档1.pdf",
      "status": "completed",
      "progress": 100
    }
  ]
}

# 获取任务详情（含问题列表）
GET /api/tasks/{id}

Response:
{
  "task": {
    "id": 1,
    "title": "文档1",
    "file_name": "文档1.pdf",
    "status": "completed",
    "progress": 100
  },
  "issues": [
    {
      "id": 1,
      "issue_type": "语法",
      "description": "存在错别字",
      "location": "第2页",
      "severity": "中",
      "suggestion": "修正错别字",
      "feedback_type": null
    }
  ]
}

# 删除任务
DELETE /api/tasks/{id}
```

### 2. 问题反馈

```python
# 提交问题反馈
PUT /api/issues/{id}/feedback
Body:
{
  "feedback_type": "accept",  # accept/reject
  "comment": "确实是问题"
}

Response:
{
  "success": true
}
```

### 3. 报告下载

```python
# 生成并下载报告
GET /api/tasks/{id}/report

Response: Excel文件流
```

## 四、后端核心实现

### 1. 任务处理流程

```python
class TaskProcessor:
    def __init__(self):
        self.file_parser = FileParser()
        self.ai_service = AIService()
    
    async def process_task(self, task_id: int):
        """处理单个任务"""
        # 获取任务
        task = Task.get(task_id)
        task.status = 'processing'
        task.save()
        
        try:
            # 1. 解析文件
            text = self.file_parser.parse(task.file_path)
            task.progress = 20
            task.save()
            
            # 2. 文本分块（8000字符）
            chunks = self.split_text(text, 8000)
            
            # 3. AI检测每个文本块
            all_issues = []
            for i, chunk in enumerate(chunks):
                issues = await self.ai_service.detect_issues(chunk)
                all_issues.extend(issues)
                
                # 更新进度
                task.progress = 20 + (70 * (i + 1) / len(chunks))
                task.save()
            
            # 4. 保存问题
            for issue_data in all_issues:
                Issue.create(
                    task_id=task_id,
                    issue_type=issue_data['type'],
                    description=issue_data['description'],
                    location=issue_data['location'],
                    severity=issue_data['severity'],
                    suggestion=issue_data['suggestion']
                )
            
            # 5. 完成任务
            task.status = 'completed'
            task.progress = 100
            task.completed_at = datetime.now()
            task.save()
            
        except Exception as e:
            task.status = 'failed'
            task.error_message = str(e)
            task.save()
```

### 2. 文件解析器

```python
class FileParser:
    def parse(self, file_path: str) -> str:
        """根据文件类型解析文件"""
        if file_path.endswith('.pdf'):
            return self.parse_pdf(file_path)
        elif file_path.endswith('.docx'):
            return self.parse_docx(file_path)
        elif file_path.endswith('.md'):
            return self.parse_markdown(file_path)
        else:
            raise ValueError("不支持的文件类型")
    
    def parse_pdf(self, file_path: str) -> str:
        """解析PDF文件"""
        import PyPDF2
        text = ""
        with open(file_path, 'rb') as file:
            pdf_reader = PyPDF2.PdfReader(file)
            for page in pdf_reader.pages:
                text += page.extract_text()
        return text
    
    def parse_docx(self, file_path: str) -> str:
        """解析Word文档"""
        from docx import Document
        doc = Document(file_path)
        return '\n'.join([p.text for p in doc.paragraphs])
    
    def parse_markdown(self, file_path: str) -> str:
        """解析Markdown文件"""
        with open(file_path, 'r', encoding='utf-8') as file:
            return file.read()
```

### 3. AI服务

```python
class AIService:
    def __init__(self):
        self.api_url = "http://localhost:8000/v1/completions"
    
    async def detect_issues(self, text: str) -> List[Dict]:
        """调用AI检测文档问题"""
        prompt = f"""
        请分析以下文档内容的质量问题：
        
        1. 语法规范性（错别字、标点符号、专业术语）
        2. 逻辑完整性（章节结构、内容连贯性）
        3. 内容质量（描述清晰度、示例完整性）
        
        输出JSON格式：
        {{
          "issues": [
            {{
              "type": "语法/逻辑/完整性",
              "description": "具体问题描述",
              "location": "问题所在位置",
              "severity": "高/中/低",
              "suggestion": "改进建议"
            }}
          ]
        }}
        
        文档内容：
        {text}
        """
        
        response = await self.call_api(prompt)
        return response.get('issues', [])
```

### 4. 报告生成

```python
def generate_report(task_id: int) -> str:
    """生成Excel报告"""
    from openpyxl import Workbook
    
    task = Task.get(task_id)
    issues = Issue.filter(task_id=task_id)
    
    wb = Workbook()
    ws = wb.active
    ws.title = "问题汇总"
    
    # 写入表头
    headers = ['序号', '类型', '描述', '位置', '严重程度', '建议', '用户反馈']
    ws.append(headers)
    
    # 写入数据
    for i, issue in enumerate(issues, 1):
        row = [
            i,
            issue.issue_type,
            issue.description,
            issue.location,
            issue.severity,
            issue.suggestion,
            issue.feedback_type or '未反馈'
        ]
        ws.append(row)
    
    # 添加统计信息
    ws.append([])
    ws.append(['统计信息'])
    ws.append(['总问题数', len(issues)])
    ws.append(['已接受', len([i for i in issues if i.feedback_type == 'accept'])])
    ws.append(['已拒绝', len([i for i in issues if i.feedback_type == 'reject'])])
    
    # 保存文件
    file_path = f"reports/{task_id}_{task.file_name}.xlsx"
    wb.save(file_path)
    return file_path
```

## 五、简化配置

### config.yaml

```yaml
# 数据库
database: ./data/app.db

# AI服务
ai_api: http://localhost:8000

# 文件设置  
max_file_size: 10485760  # 10MB
chunk_size: 8000

# 目录
upload_dir: ./data/uploads
report_dir: ./data/reports
```

### 启动命令

```bash
# 后端
uvicorn main:app --host 0.0.0.0 --port 8080

# 前端  
npm start
```

## 六、最简开发计划

### 第1周：基础搭建
- [ ] SQLite数据库和模型
- [ ] 文件上传API
- [ ] 任务创建API
- [ ] 前端上传页面

### 第2周：核心处理
- [ ] 文件解析（PDF/Word/MD）
- [ ] AI调用封装
- [ ] 任务处理器
- [ ] 进度更新

### 第3周：用户交互
- [ ] 任务列表页面
- [ ] 任务详情页面
- [ ] 问题反馈功能
- [ ] 报告生成下载

### 第4周：测试完善
- [ ] 整体流程测试
- [ ] 错误处理
- [ ] 界面优化
- [ ] 部署文档

## 七、技术栈总结

```
后端：FastAPI + SQLite + vLLM
前端：React + Ant Design
部署：Python 3.8+ / Node.js 14+
```

## 八、核心业务流程

```
用户上传文件（可批量）
    ↓
系统为每个文件创建独立任务
    ↓
后台异步处理每个任务
    ↓
用户查看任务进度和结果
    ↓
用户对问题进行反馈
    ↓
生成并下载Excel报告
```