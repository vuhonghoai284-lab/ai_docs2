# AI资料自主测试系统 - 任务清单（优化版）

## 一、数据模型设计

### 1. 任务表 (Tasks)

- id: 主键，自增ID  
- title: 任务标题
- detection_type: 检测类型（static/dynamic）
- status: 任务状态（pending/processing/completed/failed/stopped）
- progress: 执行进度（0-100）
- current_stage: 当前执行阶段
- total_files: 总文件数
- processed_files: 已处理文件数
- created_at: 创建时间
- updated_at: 更新时间
- started_at: 开始执行时间
- completed_at: 完成时间
- error_message: 错误信息

### 2. 文件表 (Files)

- id: 主键，自增ID
- task_id: 关联任务ID
- file_name: 原始文件名
- file_path: 存储路径
- file_size: 文件大小（字节）
- file_type: 文件类型（pdf/docx/md）
- upload_status: 上传状态（uploading/uploaded/failed）
- created_at: 创建时间

### 3. 文档内容表 (DocumentChunks)

- id: 主键
- file_id: 关联文件ID
- task_id: 关联任务ID
- chunk_order: 文本块顺序
- original_text: 原始文本
- chunk_size: 文本块大小
- created_at: 创建时间

### 4. 结构化内容表 (StructuredContent)

- id: 主键
- task_id: 关联任务ID
- file_id: 关联文件ID
- chunk_id: 关联文本块ID
- chapter_name: 章节名称
- content_body: 正文内容
- table_content: 表格内容
- chapter_summary: 章节摘要
- chapter_type: 章节类型（操作类/描述类）
- ai_model_used: 使用的AI模型
- processing_time: 处理耗时（秒）
- created_at: 创建时间

### 5. 检测问题表 (DetectionIssues)

- id: 主键，自增ID
- task_id: 关联任务ID
- file_id: 关联文件ID
- issue_type: 问题类型（语法/逻辑/完整性）
- description: 问题描述
- location: 所在位置（章节/页码）
- severity: 严重程度（高/中/低）
- suggestion: 改进建议
- created_at: 创建时间

### 6. 用户反馈表 (UserFeedback)

- id: 主键，自增ID
- task_id: 关联任务ID
- issue_id: 关联问题ID
- feedback_type: 反馈类型（accept/reject）
- comment: 用户评价
- created_at: 创建时间

### 7. AI调用记录表 (AICallLogs)

- id: 主键，自增ID
- task_id: 关联任务ID
- model_name: 使用的模型
- prompt_type: 提示词类型（structure/detection）
- input_length: 输入长度
- output_length: 输出长度
- duration: 耗时（秒）
- status: 调用状态（success/failed）
- error_message: 错误信息
- created_at: 创建时间

### 8. 报告表 (Reports)

- id: 主键，自增ID
- task_id: 关联任务ID
- report_type: 报告类型（preliminary/final）
- file_name: 报告文件名
- file_path: 报告存储路径
- file_size: 文件大小
- status: 生成状态（generating/completed/failed）
- total_issues: 问题总数
- accepted_issues: 接受的问题数
- rejected_issues: 拒绝的问题数
- generated_at: 生成时间
- created_at: 创建时间

## 二、前端开发计划

### 1. 页面结构设计

```
src/
├── pages/
│   ├── TaskCreate/          # 任务创建页面
│   │   ├── index.tsx
│   │   ├── FileUpload.tsx   # 文件上传组件
│   │   └── TaskForm.tsx     # 任务表单组件
│   │
│   ├── TaskList/            # 任务列表页面
│   │   ├── index.tsx
│   │   ├── TaskCard.tsx     # 任务卡片组件
│   │   ├── TaskFilters.tsx  # 任务筛选器
│   │   └── TaskActions.tsx  # 操作按钮组
│   │
│   ├── TaskDetail/          # 任务详情页面
│   │   ├── index.tsx
│   │   ├── FileList.tsx     # 文件列表组件
│   │   ├── IssuesList.tsx   # 问题列表组件
│   │   └── TaskProgress.tsx # 进度显示组件
│   │
│   └── IssueReview/         # 问题审核页面
│       ├── index.tsx
│       ├── IssueCard.tsx    # 问题卡片组件
│       └── FeedbackForm.tsx # 反馈表单组件
│
├── services/
│   ├── api.ts               # API请求封装
│   ├── taskService.ts       # 任务相关服务
│   └── reportService.ts     # 报告相关服务
│
├── utils/
│   ├── fileValidator.ts     # 文件验证工具
│   ├── formatters.ts        # 格式化工具
│   └── constants.ts         # 常量定义
│
└── types/
    └── index.ts             # 类型定义
```

### 2. 核心组件开发

#### 2.1 文件上传组件 (FileUpload.tsx)

**功能要求：**
- 支持拖拽上传和点击上传
- 支持多文件选择（可配置）
- 文件类型验证（PDF、DOCX、MD）
- 文件大小验证（默认10MB，可配置）
- 文件列表显示和管理

**开发任务：**
- [ ] 实现拖拽上传交互
- [ ] 集成文件验证逻辑
- [ ] 添加文件列表管理
- [ ] 错误提示设计

#### 2.2 任务卡片组件 (TaskCard.tsx)

**功能要求：**
- 显示任务基本信息
- 显示任务状态和进度
- 提供操作按钮（查看/下载/重试/删除/停止）

**开发任务：**
- [ ] 设计卡片布局
- [ ] 实现进度条显示
- [ ] 添加状态标签
- [ ] 集成操作按钮

#### 2.3 问题卡片组件 (IssueCard.tsx)

**功能要求：**
- 显示问题详细信息
- 支持接受/拒绝操作
- 支持添加评价

**开发任务：**
- [ ] 设计问题卡片布局
- [ ] 实现反馈操作
- [ ] 添加评价输入

### 3. 状态管理设计

使用React Context + useReducer进行简单状态管理：

```typescript
interface AppState {
  tasks: Task[];
  currentTask: Task | null;
  issues: Issue[];
  loading: boolean;
  error: string | null;
}
```

## 三、后端开发计划

### 1. API接口设计

#### 1.1 任务管理接口

```
POST   /api/tasks                 # 创建任务
GET    /api/tasks                 # 获取任务列表
GET    /api/tasks/{task_id}       # 获取任务详情
DELETE /api/tasks/{task_id}       # 删除任务
POST   /api/tasks/{task_id}/stop  # 停止任务
POST   /api/tasks/{task_id}/retry # 重试任务
```

#### 1.2 问题管理接口

```
GET    /api/tasks/{task_id}/issues              # 获取问题列表
POST   /api/tasks/{task_id}/issues/{issue_id}/feedback  # 提交反馈
```

#### 1.3 报告管理接口

```
POST   /api/tasks/{task_id}/report/generate     # 生成报告
GET    /api/tasks/{task_id}/report/download     # 下载报告
```

#### 1.4 进度查询接口

```
GET    /api/tasks/{task_id}/progress            # 获取任务进度（轮询）
```

### 2. 文件处理模块

#### 2.1 文件上传处理

**开发任务：**
- [ ] 实现文件接收和存储
- [ ] 文件类型和大小验证
- [ ] 文件路径管理

#### 2.2 文件解析器

**开发任务：**
- [ ] PDF文件解析器（PyPDF2/pdfplumber）
- [ ] Word文档解析器（python-docx）
- [ ] Markdown文件解析器
- [ ] 文本分块处理（默认8000字符）

### 3. 任务执行引擎

#### 3.1 任务处理器

```python
class TaskProcessor:
    def __init__(self, db_session):
        self.db = db_session
        self.ai_client = AIClient()
    
    async def process_task(self, task_id: str):
        """处理任务主流程"""
        task = self.get_task(task_id)
        
        # 阶段1：文件解析
        await self.parse_files(task)
        
        # 阶段2：文本结构化
        await self.structure_text(task)
        
        # 阶段3：静态检测
        await self.detect_issues(task)
        
        # 阶段4：完成处理
        await self.complete_task(task)
    
    async def stop_task(self, task_id: str):
        """停止任务执行"""
        task = self.get_task(task_id)
        task.status = 'stopped'
        self.db.commit()
```

#### 3.2 执行流程设计

- **阶段1：文件解析 (0-20%)**
  - 文件读取和验证
  - 文本内容提取
  - 文本分块处理

- **阶段2：文本结构化 (20-60%)**
  - AI模型调用
  - 结构化数据提取
  - 数据验证和存储

- **阶段3：静态检测 (60-90%)**
  - 质量问题检测
  - 问题分类和评级
  - 结果存储

- **阶段4：数据整理 (90-100%)**
  - 检测结果汇总
  - 任务状态更新

### 4. 报告生成模块

```python
class ReportGenerator:
    def __init__(self):
        self.excel_writer = ExcelWriter()
    
    async def generate_report(self, task_id: str):
        """生成Excel报告"""
        # 获取数据
        task = get_task(task_id)
        issues = get_issues(task_id)
        feedbacks = get_feedbacks(task_id)
        
        # 生成Excel文件
        wb = Workbook()
        
        # Sheet1: 问题汇总
        ws1 = wb.active
        ws1.title = "问题汇总"
        self.write_issues_sheet(ws1, issues, feedbacks)
        
        # Sheet2: 统计分析
        ws2 = wb.create_sheet("统计分析")
        self.write_statistics_sheet(ws2, issues, feedbacks)
        
        # Sheet3: 改进建议
        ws3 = wb.create_sheet("改进建议")
        self.write_suggestions_sheet(ws3, issues)
        
        # 保存文件
        file_path = f"reports/{task_id}.xlsx"
        wb.save(file_path)
        
        return file_path
```

## 四、AI集成模块

### 1. AI模型配置

配置文件 (config.yaml)：

```yaml
ai_models:
  vllm:
    api_host: "http://localhost:8000"
    model_name: "qwen-plus"
    max_tokens: 8192
    temperature: 0.1
    
settings:
  chunk_size: 8000
  max_file_size: 10485760  # 10MB
  retry_attempts: 3
  timeout: 30
```

### 2. AI服务封装

```python
class AIClient:
    def __init__(self, config):
        self.config = config
        self.base_url = config['ai_models']['vllm']['api_host']
    
    async def call_model(self, prompt: str, prompt_type: str):
        """调用AI模型"""
        try:
            response = await self._post_request(prompt)
            return self._parse_response(response)
        except Exception as e:
            logger.error(f"AI调用失败: {e}")
            raise
```

### 3. 提示词模板

```python
# 文本结构化提示词
STRUCTURE_PROMPT = """
请将以下文档内容进行结构化提取，输出JSON格式：
{
  "chapter_name": "章节名称",
  "content_body": "正文内容",
  "table_content": "表格内容",
  "chapter_summary": "章节摘要",
  "chapter_type": "操作类/描述类"
}

文档内容：
{content}
"""

# 静态检测提示词
DETECTION_PROMPT = """
请分析以下文档内容的质量问题，从语法规范性、逻辑完整性、内容质量三个维度评估：

输出JSON格式：
{
  "issues": [
    {
      "type": "语法/逻辑/完整性",
      "description": "问题描述",
      "location": "所在位置",
      "severity": "高/中/低",
      "suggestion": "改进建议"
    }
  ]
}

文档内容：
{content}
"""
```

## 五、错误处理和日志

### 1. 简单日志系统

```python
import logging

# 配置日志
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('app.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)
```

### 2. 错误处理

```python
class AppError(Exception):
    """应用错误基类"""
    pass

class FileValidationError(AppError):
    """文件验证错误"""
    pass

class AIServiceError(AppError):
    """AI服务错误"""
    pass
```

## 六、测试计划

### 1. 单元测试

- [ ] 文件验证函数测试
- [ ] 文件解析器测试
- [ ] AI接口调用测试
- [ ] 报告生成测试

### 2. 集成测试

- [ ] 完整任务流程测试
- [ ] 多文件上传测试
- [ ] 错误场景测试

### 3. 用户验收测试

- [ ] 上传文档并创建任务
- [ ] 查看任务进度
- [ ] 审核问题并提交反馈
- [ ] 生成并下载报告

## 七、部署和配置

### 1. 环境要求

```
Python 3.8+
Node.js 14+
SQLite 3
vLLM部署环境
```

### 2. 配置文件

```yaml
# config.yaml
database:
  type: sqlite
  path: ./data/app.db

storage:
  upload_dir: ./data/uploads
  report_dir: ./data/reports

server:
  host: 0.0.0.0
  port: 8080
  
frontend:
  api_base_url: http://localhost:8080/api
  poll_interval: 2000  # 轮询间隔（毫秒）
```

### 3. 启动脚本

```bash
# 后端启动
python main.py

# 前端启动
npm start
```

## 八、开发优先级

### P0 - 核心功能（第一阶段）

1. 文件上传和验证
2. 任务创建和列表
3. 文件解析处理
4. AI调用和检测
5. 问题列表展示

### P1 - 完整功能（第二阶段）

1. 问题反馈功能
2. 报告生成和下载
3. 任务停止功能
4. 任务重试功能

### P2 - 优化功能（第三阶段）

1. 进度显示优化
2. 错误处理完善
3. 日志记录完善
4. 性能优化